# アーキテクチャ概要

LorentzArena は小さめの実験プロジェクトですが、考え方としては大きく3つに分かれます。

- **物理（特殊相対論）**
- **描画/UI（React + WebGL）**
- **通信（PeerJS / WebRTC）**

このドキュメントでは、それぞれがどう繋がっているかをざっくり説明します。

---

## リポジトリ内のアプリ

- ルート（root）: 1+1 次元の時空図（x–t）スタイル
- `2+1/`: 2+1 次元の時空図（x–y–t）スタイル（`three.js` / `@react-three/fiber`）

物理と通信は、なるべくアプリ間で似た設計にしています。

---

## 物理レイヤ（`src/physics/...`）

物理モジュールはクラスではなく、**関数（factory）+ plain object** で書いています。

主な概念:

- **Vector3**: 空間ベクトル（3元速度など）
- **Vector4**: 4元位置 `(t, x, y, z)`
- **PhaseSpace**: プレイヤー状態のスナップショット
  - `pos`: 世界系での4元位置
  - `u`: 世界系での3元速度
- **WorldLine**: 位相空間を時系列に貯めたもの（時空間上の軌跡の離散近似）

ゲームループでは、自分の位相空間を（固有時間で）更新してワールドラインに追加します。

さらに、他プレイヤーは「今どこにいるか」ではなく、**自分の過去光円錐と相手の世界線の交点**を使って “見える位置” を計算しています。

---

## 通信レイヤ（`src/services/PeerManager.ts`, `src/contexts/PeerProvider.tsx`）

- `PeerManager<T>`: PeerJS（WebRTCデータチャネル）を薄くラップしたもの
- `PeerProvider`: React コンポーネントから PeerManager を使えるようにする Context

ゲームは JSON メッセージ（位相空間更新・レーザーなど）を送り、受け取ったらローカル状態を更新します。

学校 Wi‑Fi などで通信が死ぬ原因と対策はここにまとめています。

- `docs/NETWORKING.ja.md`

---

## UI レイヤ

- ルート（root）: 2D の時空グリッド上にオブジェクトを描画
- `2+1/`: 3D の時空シーンを描画
  - X/Y が空間
  - Z を **時間（t）** として使う

時間を縦軸にすると、世界線（world line）が本当に “線” になるので、時空図としての直感が得やすいです。
